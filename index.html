<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AllAddIn99</title>
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1> AllAddIn99 </h1>

    <div class="main-container">
        <!-- Secci贸n de Subida -->
        <div class="section upload">
            <input type="file" id="fileInput" class="file-input" onchange="updateFileName()">
            <label for="fileInput" class="file-label">Examinar</label>
            <button onclick="shareFile()"> Compartir archivo</button>
            <p id="fileName" class="file-name"></p> <!-- Elemento para mostrar el nombre del archivo -->
        </div>
        <div class="section download">
            <input type="text" id="torrentId" placeholder="Magnet link o archivo .torrent">
            <button onclick="downloadTorrent()"> Descargar</button>
        </div>
    </div>

    <br><br>
    <!--<video id="videoPlayer" controls></video>-->
    <div class="status-container">
        <div id="status"></div>
        <button class="copy-button" onclick="copyToClipboard()"> Copiar enlace</button>
    </div>
    <div id="downloadLinks"></div>

    <script>
        // Configuraci贸n del cliente WebTorrent con DHT habilitado
        const client = new WebTorrent({
            dht: true,   // Habilitar DHT para descentralizaci贸n
            tracker: true // Habilitar el uso de trackers
        });

        // Funci贸n para encriptar un texto
        function encrypt(text, key) {
            return CryptoJS.AES.encrypt(text, key).toString();
        }

        // Funci贸n para desencriptar un texto
        function decrypt(text, key) {
            const bytes = CryptoJS.AES.decrypt(text, key);
            return bytes.toString(CryptoJS.enc.Utf8);
        }

        // Funci贸n para acortar un enlace usando TinyURL (ejemplo simple)
        function shortenUrl(url) {
            return fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(url)}`)
                .then(response => response.text());
        }

        // Compartir archivo
        async function shareFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const encryptionKey = "P@ssw0rd!2024$SecureKey"; // Usa una clave segura en un entorno real

            if (file) {
                client.seed(file, async (torrent) => {
                    const magnetURI = torrent.magnetURI;

                    // Encriptar el enlace magn茅tico
                    const encryptedMagnetURI = encrypt(magnetURI, encryptionKey);

                    // Acortar el enlace encriptado
                    const shortenedUrl = await shortenUrl(encryptedMagnetURI);

                    // Mostrar el enlace acortado
                    document.getElementById('status').innerHTML = 'Enlace acortado: <a href="' + shortenedUrl + '">' + shortenedUrl + '</a>';
                    console.log('Magnet URI encriptado:', encryptedMagnetURI);
                    console.log('Enlace acortado:', shortenedUrl);
                }).on('error', (err) => {
                    console.error('Error al compartir archivo:', err);
                    document.getElementById('status').innerHTML = 'Error al compartir archivo. Revisa la consola para m谩s detalles.';
                });
            } else {
                alert('Por favor, selecciona un archivo.');
            }
        }

        // Descargar torrent
        function downloadTorrent() {
            let torrentId = document.getElementById('torrentId').value;
            const decryptionKey = "P@ssw0rd!2024$SecureKey"; // Usa la misma clave que en el proceso de encriptaci贸n

            if (torrentId) {
                // Desencriptar el enlace magn茅tico
                try {
                    torrentId = decrypt(torrentId, decryptionKey);
                } catch (err) {
                    console.error('Error al desencriptar el enlace:', err);
                    alert('El enlace es inv谩lido o no se pudo desencriptar.');
                    return;
                }

                client.add(torrentId, (torrent) => {
                    document.getElementById('downloadLinks').innerHTML = ''; // Limpiar enlaces anteriores

                    torrent.files.forEach((file) => {
                        if (file.name.endsWith('.mp4') || file.name.endsWith('.webm')) {
                            file.renderTo('video#videoPlayer');
                        } else {
                            file.getBlobURL((err, url) => {
                                if (err) {
                                    console.error('Error al obtener URL del blob:', err);
                                    document.getElementById('status').innerHTML = 'Error al obtener URL del blob. Revisa la consola para m谩s detalles.';
                                } else {
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = file.name;
                                    a.textContent = 'Descargar ' + file.name;
                                    document.getElementById('downloadLinks').appendChild(a);
                                    document.getElementById('downloadLinks').appendChild(document.createElement('br'));
                                }
                            });
                        }
                    });
                }).on('error', (err) => {
                    console.error('Error al descargar torrent:', err);
                    document.getElementById('status').innerHTML = 'Error al descargar torrent. Revisa la consola para m谩s detalles.';
                });
            } else {
                alert('Por favor, introduce un enlace Magnet o un archivo .torrent.');
            }
        }

        function copyToClipboard() {
            const statusElement = document.getElementById('status');
            const link = statusElement.querySelector('a');
            if (link) {
                navigator.clipboard.writeText(link.href).then(() => {
                    alert('Enlace copiado al portapapeles');
                }).catch(err => {
                    console.error('Error al copiar enlace: ', err);
                });
            } else {
                alert('No hay ning煤n enlace para copiar.');
            }
        }

        function updateFileName() {
            const fileInput = document.getElementById('fileInput');
            const fileNameElement = document.getElementById('fileName');

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileNameElement.textContent = `Archivo seleccionado: ${file.name}`;
            } else {
                fileNameElement.textContent = '';
            }
        }
    </script>

    <footer>
        漏 2024 AllAddIn99
    </footer>
</body>
</html>
